# Documentaci√≥n de Actualizaciones - Lab27 y Lab28

## üìÖ Fecha: 28 de Octubre, 2025

---

## üéØ Resumen General

En los laboratorios 27 y 28 se implement√≥ un **sistema completo de control de acceso basado en roles (RBAC)** y una **interfaz de administraci√≥n** para el e-commerce MinCommerce. Estas implementaciones permiten gestionar usuarios con diferentes niveles de acceso y proporcionar herramientas administrativas para la gesti√≥n de productos y √≥rdenes.

---

## üîê Autenticaci√≥n con OAuth2 y Autorizaci√≥n y Roles

### 1. Configuraci√≥n de NextAuth con Roles

#### 1.1 Extensi√≥n de Interfaces TypeScript

**Archivo:** `types/next-auth.d.ts`

Se extendieron las interfaces de NextAuth para incluir campos personalizados:

```typescript
declare module "next-auth" {
  interface Session {
    user: {
      id: string
      name?: string | null
      email?: string | null
      image?: string | null
      role: "admin" | "user"
    }
  }

  interface User {
    id: string
    role: "admin" | "user"
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    role: "admin" | "user"
  }
}
```

#### 1.2 Configuraci√≥n de Auth.ts

**Archivo:** `auth.ts`

Se configur√≥ NextAuth para manejar roles de usuario:

- **Definici√≥n de roles**: Se estableci√≥ que el email espec√≠fico tiene rol "admin", otros usuarios tienen rol "user"
- **Callbacks JWT**: Se agreg√≥ el rol al token JWT
- **Callbacks Session**: Se incluy√≥ el rol en la sesi√≥n del usuario
- **Type Safety**: Se agreg√≥ type assertion para evitar errores de TypeScript

```typescript
callbacks: {
  jwt({ token, user }) {
    if (user) {
      token.role = user.email === "admin@example.com" ? "admin" : "user"
    }
    return token
  },
  session({ session, token }) {
    if (token.sub && session.user) {
      session.user.id = token.sub
      session.user.role = token.role as "admin" | "user"
    }
    return session
  },
}
```

### 2. Middleware de Autorizaci√≥n

#### 2.1 Implementaci√≥n del Middleware

**Archivo:** `middleware.ts`

Se cre√≥ un middleware robusto que maneja diferentes niveles de acceso:

- **Rutas Protegidas**: `/profile`, `/order` (requieren autenticaci√≥n b√°sica)
- **Rutas de Admin**: `/admin` (requieren rol de administrador)
- **Redirecciones Inteligentes**:
  - Sin sesi√≥n ‚Üí P√°gina principal
  - Sin permisos de admin ‚Üí P√°gina de no autorizaci√≥n

#### 2.2 Optimizaci√≥n del Matcher

Se optimiz√≥ la configuraci√≥n para mejor rendimiento:

```typescript
export const config = {
  matcher: [
    '/profile/:path*',
    '/order/:path*', 
    '/admin/:path*',
  ],
}
```

**Beneficios:**

- ‚úÖ Mejor rendimiento (solo se ejecuta donde es necesario)
- ‚úÖ Mayor claridad en las rutas protegidas
- ‚úÖ Menos carga en el servidor
- ‚úÖ F√°cil escalabilidad

---

## üõ†Ô∏è Interfaz de Administraci√≥n

### 1. Panel de Administraci√≥n Completo

#### 1.1 Vista Principal de Admin

**Archivo:** `app/admin/page.tsx`

Se implement√≥ una interfaz completa de administraci√≥n con:

**Dashboard con Estad√≠sticas:**

- Total de productos en inventario
- N√∫mero total de √≥rdenes
- Ingresos totales generados
- Dise√±o con cards informativos

**Gesti√≥n de Productos:**

- Lista completa de productos con informaci√≥n detallada
- Formulario para agregar nuevos productos
- Opciones de editar y eliminar productos existentes
- Validaci√≥n de campos requeridos
- Manejo de stock y precios

**Gesti√≥n de √ìrdenes:**

- Vista de todas las √≥rdenes del sistema
- Informaci√≥n detallada de cada orden
- Datos del cliente y productos ordenados
- Estados y totales de las √≥rdenes

#### 1.2 Caracter√≠sticas T√©cnicas

- **Autenticaci√≥n Integrada**: Verificaci√≥n autom√°tica del rol de admin
- **UI Moderna**: Dise√±o responsive con Tailwind CSS
- **Componentes Reutilizables**: Uso de shadcn/ui components
- **Manejo de Estados**: Loading states y error handling
- **API Integration**: Conexi√≥n con endpoints existentes

### 2. P√°gina de No Autorizaci√≥n

#### 2.1 Implementaci√≥n

**Archivo:** `app/unauthorized/page.tsx`

Se cre√≥ una p√°gina dedicada para usuarios sin permisos:

**Caracter√≠sticas:**

- Mensaje claro de acceso denegado
- Informaci√≥n de la sesi√≥n actual del usuario
- Opciones de navegaci√≥n (regresar al inicio, iniciar sesi√≥n)
- Redirecci√≥n autom√°tica para administradores
- Dise√±o consistente con el resto de la aplicaci√≥n

### 3. Navegaci√≥n Condicional

#### 3.1 Navbar Inteligente

**Archivo:** `components/navbar.tsx`

Se modific√≥ la barra de navegaci√≥n para mostrar enlaces condicionalmente:

```typescript
// Solo agregar la ruta de Admin si el usuario es administrador
if (session?.user?.role === 'admin') {
  routes.push({ href: "/admin", label: "Admin" });
}
```

**Funcionalidad:**

- El enlace "Admin" solo aparece para usuarios con rol de administrador
- Actualizaci√≥n din√°mica seg√∫n el estado de la sesi√≥n
- Funciona tanto en navegaci√≥n desktop como m√≥vil

---

## üîí Seguridad Implementada

### 1. Autenticaci√≥n y Autorizaci√≥n

- **Verificaci√≥n de Sesi√≥n**: Middleware autom√°tico
- **Control de Roles**: Acceso basado en permisos
- **Redirecciones Seguras**: Prevenci√≥n de acceso no autorizado
- **Type Safety**: Tipado estricto en TypeScript

### 2. Validaciones

- **Input Validation**: Validaci√≥n de datos de entrada
- **ID Validation**: Verificaci√≥n de par√°metros num√©ricos
- **Error Handling**: Manejo robusto de errores
- **Session Management**: Gesti√≥n segura de sesiones

---

## üìù Notas T√©cnicas

- **Versi√≥n de Next.js**: 15.5.4
- **Base de Datos**: PostgreSQL con Prisma
- **Autenticaci√≥n**: NextAuth.js v5
- **Estilos**: Tailwind CSS + shadcn/ui
- **TypeScript**: Tipado estricto habilitado

---

*Documentaci√≥n generada el 28 de octubre de 2025*
*Proyecto: MinCommerce - E-commerce con Next.js*